<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UltraFast Social - The Future of Social Media</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 1.1rem;
      }

      .upload-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .file-input-wrapper {
        position: relative;
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .file-input-wrapper:hover {
        border-color: #764ba2;
        background: rgba(102, 126, 234, 0.05);
      }

      .file-input-wrapper.dragover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.1);
        transform: scale(1.02);
      }

      .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 10px;
      }

      .upload-hint {
        font-size: 0.9rem;
        color: #999;
      }

      .preview-container {
        margin-top: 20px;
        text-align: center;
      }

      .preview-media {
        max-width: 100%;
        max-height: 400px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .caption-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 15px;
        font-size: 1rem;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.3s ease;
      }

      .caption-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .upload-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .upload-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 30px;
        margin-top: 30px;
      }

      .post-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      .post-header {
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .post-info h3 {
        font-size: 1.1rem;
        margin-bottom: 5px;
      }

      .post-info p {
        color: #666;
        font-size: 0.9rem;
      }

      .post-media {
        position: relative;
        width: 100%;
        height: 300px;
        overflow: hidden;
      }

      .post-media img,
      .post-media video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .post-actions {
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .action-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.3s ease;
        color: #666;
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .action-btn.liked {
        color: #e74c3c;
      }

      .post-caption {
        padding: 0 20px 20px;
        color: #333;
        line-height: 1.5;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-indicator {
        padding: 10px 20px;
        margin: 10px 0;
        border-radius: 10px;
        font-weight: 500;
      }

      .status-processing {
        background: rgba(255, 193, 7, 0.1);
        color: #856404;
        border: 1px solid rgba(255, 193, 7, 0.3);
      }

      .status-ready {
        background: rgba(40, 167, 69, 0.1);
        color: #155724;
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      .status-failed {
        background: rgba(220, 53, 69, 0.1);
        color: #721c24;
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      .streaming-controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .stream-btn {
        background: rgba(102, 126, 234, 0.8);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .stream-btn:hover {
        background: rgba(102, 126, 234, 1);
      }

      .stream-btn.active {
        background: rgba(118, 75, 162, 0.8);
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .posts-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-bolt"></i> UltraFast Social</h1>
        <p>
          The fastest social media platform powered by LL-DASH & LL-HLS
          streaming
        </p>
      </div>

      <div class="upload-section">
        <h2 style="margin-bottom: 20px; color: #333">
          <i class="fas fa-plus-circle"></i> Create New Post
        </h2>

        <form class="upload-form" id="uploadForm">
          <div class="file-input-wrapper" id="fileInputWrapper">
            <input
              type="file"
              id="fileInput"
              class="file-input"
              accept="image/*,video/*"
              required
            />
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Click to upload or drag & drop</div>
            <div class="upload-hint">Images and videos up to 500MB</div>
          </div>

          <div
            class="preview-container"
            id="previewContainer"
            style="display: none"
          >
            <div id="previewMedia"></div>
          </div>

          <textarea
            id="captionInput"
            class="caption-input"
            placeholder="Write a caption for your post..."
            maxlength="2000"
          ></textarea>

          <button type="submit" class="upload-btn" id="uploadBtn">
            <i class="fas fa-upload"></i>
            Upload Post
          </button>
        </form>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading posts...</div>
      </div>

      <div class="posts-grid" id="postsGrid">
        <!-- Posts will be loaded here -->
      </div>
    </div>

    <!-- Streaming Libraries -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="/js/streaming-player.js"></script>
    <script>
      class UltraFastSocial {
        constructor() {
          this.currentUserId = 1; // Default user ID for testing
          this.posts = [];
          this.streamingPlayers = new Map(); // Track streaming players
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.loadPosts();
        }

        setupEventListeners() {
          const fileInput = document.getElementById("fileInput");
          const fileInputWrapper = document.getElementById("fileInputWrapper");
          const uploadForm = document.getElementById("uploadForm");

          // File input change
          fileInput.addEventListener("change", (e) => this.handleFileSelect(e));

          // Drag and drop
          fileInputWrapper.addEventListener("dragover", (e) => {
            e.preventDefault();
            fileInputWrapper.classList.add("dragover");
          });

          fileInputWrapper.addEventListener("dragleave", () => {
            fileInputWrapper.classList.remove("dragover");
          });

          fileInputWrapper.addEventListener("drop", (e) => {
            e.preventDefault();
            fileInputWrapper.classList.remove("dragover");
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              fileInput.files = files;
              this.handleFileSelect({ target: { files: files } });
            }
          });

          // Form submission
          uploadForm.addEventListener("submit", (e) => this.handleSubmit(e));
        }

        handleFileSelect(event) {
          const file = event.target.files[0];
          if (!file) return;

          const previewContainer = document.getElementById("previewContainer");
          const previewMedia = document.getElementById("previewMedia");

          previewContainer.style.display = "block";

          if (file.type.startsWith("image/")) {
            previewMedia.innerHTML = `<img src="${URL.createObjectURL(
              file
            )}" class="preview-media" alt="Preview">`;
          } else if (file.type.startsWith("video/")) {
            previewMedia.innerHTML = `
                        <video controls class="preview-media">
                            <source src="${URL.createObjectURL(file)}" type="${
              file.type
            }">
                        </video>
                    `;
          }
        }

        async handleSubmit(event) {
          event.preventDefault();

          const fileInput = document.getElementById("fileInput");
          const captionInput = document.getElementById("captionInput");
          const uploadBtn = document.getElementById("uploadBtn");

          if (!fileInput.files[0]) {
            alert("Please select a file to upload");
            return;
          }

          const formData = new FormData();
          formData.append("media", fileInput.files[0]);
          formData.append("caption", captionInput.value);
          formData.append("userId", this.currentUserId);

          uploadBtn.disabled = true;
          uploadBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Uploading...';

          try {
            const response = await fetch("/api/posts", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              // Store file info before resetting form
              const uploadedFile = fileInput.files[0];

              alert("Post uploaded successfully! Processing...");
              this.resetForm();
              this.loadPosts();

              // If it's a video, start checking processing status
              if (uploadedFile && uploadedFile.type.startsWith("video/")) {
                this.checkProcessingStatus(result.postId);
              }
            } else {
              alert("Upload failed: " + result.error);
            }
          } catch (error) {
            console.error("Upload error:", error);
            alert("Upload failed. Please try again.");
          } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Post';
          }
        }

        resetForm() {
          document.getElementById("uploadForm").reset();
          document.getElementById("previewContainer").style.display = "none";
          document
            .getElementById("fileInputWrapper")
            .classList.remove("dragover");
        }

        async loadPosts() {
          const loading = document.getElementById("loading");
          const postsGrid = document.getElementById("postsGrid");

          loading.classList.add("show");
          postsGrid.innerHTML = "";

          try {
            const response = await fetch("/api/posts");
            const result = await response.json();

            if (result.success) {
              this.posts = result.posts;
              this.renderPosts();
            } else {
              console.error("Failed to load posts:", result.error);
            }
          } catch (error) {
            console.error("Error loading posts:", error);
          } finally {
            loading.classList.remove("show");
          }
        }

        renderPosts() {
          const postsGrid = document.getElementById("postsGrid");

          if (this.posts.length === 0) {
            postsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-images" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>No posts yet</h3>
                            <p>Be the first to share something amazing!</p>
                        </div>
                    `;
            return;
          }

          postsGrid.innerHTML = this.posts
            .map((post) => this.createPostCard(post))
            .join("");
        }

        createPostCard(post) {
          const isVideo = post.media_type === "video";
          const hasStreaming = post.dash_manifest_url && post.hls_playlist_url;

          let mediaElement = "";
          let statusIndicator = "";
          let streamingControls = "";

          if (post.processing_status === "processing") {
            statusIndicator =
              '<div class="status-indicator status-processing"><i class="fas fa-cog fa-spin"></i> Processing video...</div>';
            mediaElement = `
                        <div style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                            <div style="text-align: center;">
                                <i class="fas fa-cog fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <div>Processing video for streaming...</div>
                            </div>
                        </div>
                    `;
          } else if (post.processing_status === "ready") {
            statusIndicator =
              '<div class="status-indicator status-ready"><i class="fas fa-check"></i> Ready for streaming</div>';

            if (isVideo && hasStreaming) {
              mediaElement = `
                            <div id="player-container-${post.id}" class="post-media" style="position: relative; background: #000;">
                                <video id="video-${post.id}" controls preload="metadata" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                                </video>
                                <div style="position: absolute; top: 10px; left: 10px; color: white; font-size: 0.7rem; z-index: 10;">
                                    <i class="fas fa-circle blink"></i> LIVE
                                </div>
                            </div>
                        `;
              streamingControls = `
                            <div class="streaming-controls">
                                <button class="stream-btn active" onclick="ultraFastSocial.loadStreaming('${post.id}', 'hls')">
                                    <i class="fas fa-play-circle"></i> HLS
                                </button>
                                <button class="stream-btn" onclick="ultraFastSocial.loadStreaming('${post.id}', 'dash')">
                                    <i class="fas fa-broadcast-tower"></i> DASH
                                </button>
                                <div style="margin-left: auto; color: white; font-size: 0.8rem;">
                                    <i class="fas fa-bolt"></i> Low Latency Streaming
                                </div>
                            </div>
                        `;
            } else if (isVideo) {
              mediaElement = `<video class="post-media" controls><source src="${post.original_media_url}" type="video/mp4"></video>`;
            } else {
              mediaElement = `<img src="${post.original_media_url}" class="post-media" alt="Post image">`;
            }
          } else if (post.processing_status === "failed") {
            statusIndicator =
              '<div class="status-indicator status-failed"><i class="fas fa-exclamation-triangle"></i> Processing failed</div>';
            mediaElement = `
                        <div style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100%; color: #dc3545;">
                            <div style="text-align: center;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <div>Processing failed</div>
                            </div>
                        </div>
                    `;
          } else {
            mediaElement = `
                        <div style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                            <div style="text-align: center;">
                                <i class="fas fa-upload" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <div>Uploading...</div>
                            </div>
                        </div>
                    `;
          }

          return `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="profile-pic">${post.username
                              .charAt(0)
                              .toUpperCase()}</div>
                            <div class="post-info">
                                <h3>${post.username}</h3>
                                <p>${new Date(
                                  post.created_at
                                ).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div class="post-media" style="position: relative;">
                            ${mediaElement}
                            ${streamingControls}
                        </div>
                        
                        ${statusIndicator}
                        
                        <div class="post-actions">
                            <button class="action-btn ${
                              post.liked ? "liked" : ""
                            }" onclick="ultraFastSocial.toggleLike(${post.id})">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-btn">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="action-btn">
                                <i class="fas fa-share"></i>
                            </button>
                            <div style="margin-left: auto; color: #666;">
                                <i class="fas fa-eye"></i> ${
                                  post.views_count || 0
                                }
                            </div>
                        </div>
                        
                        <div class="post-caption">
                            ${post.caption || ""}
                        </div>
                    </div>
                `;
        }

        async toggleLike(postId) {
          try {
            const response = await fetch(`/api/posts/${postId}/like`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ userId: this.currentUserId }),
            });

            const result = await response.json();
            if (result.success) {
              this.loadPosts(); // Reload to update like count
            }
          } catch (error) {
            console.error("Error toggling like:", error);
          }
        }

        async loadStreaming(postId, type) {
          const post = this.posts.find((p) => p.id == postId);
          if (!post) {
            console.error("Post not found:", postId);
            return;
          }

          const containerId = `player-container-${postId}`;
          const container = document.getElementById(containerId);
          if (!container) {
            console.error("Player container not found:", containerId);
            return;
          }

          // Update button states
          const buttons = container.querySelectorAll(".stream-btn");
          buttons.forEach((btn) => btn.classList.remove("active"));
          buttons.forEach((btn) => {
            if (btn.textContent.includes(type.toUpperCase())) {
              btn.classList.add("active");
            }
          });

          // Get or create streaming player
          let player = this.streamingPlayers.get(postId);
          if (!player) {
            console.log("Creating new streaming player for post", postId);
            player = new StreamingPlayer(containerId, {
              autoplay: true,
              controls: true,
              fallbackToDash: true,
              fallbackToHLS: true,
            });
            this.streamingPlayers.set(postId, player);
            await player.initialize();
          }

          try {
            const streamUrls = {
              hls: post.hls_playlist_url,
              dash: post.dash_manifest_url,
            };

            console.log("Loading stream:", { type, urls: streamUrls });

            if (type === "hls" && streamUrls.hls) {
              console.log("Loading HLS stream:", streamUrls.hls);
              await player.loadHLS(streamUrls.hls);
              console.log(
                `✓ HLS stream loaded successfully for post ${postId}`
              );
            } else if (type === "dash" && streamUrls.dash) {
              console.log("Loading DASH stream:", streamUrls.dash);
              await player.loadDASH(streamUrls.dash);
              console.log(
                `✓ DASH stream loaded successfully for post ${postId}`
              );
            } else {
              console.warn(`Stream URL not available for ${type} format`);

              // Try fallback to the other format
              if (type === "hls" && streamUrls.dash) {
                console.log("Falling back to DASH...");
                await player.loadDASH(streamUrls.dash);
              } else if (type === "dash" && streamUrls.hls) {
                console.log("Falling back to HLS...");
                await player.loadHLS(streamUrls.hls);
              } else {
                // Final fallback to original video
                console.log("Falling back to original video...");
                const video = container.querySelector(`#video-${postId}`);
                if (video) {
                  video.src = post.original_media_url;
                  video.play().catch((e) => console.log("Play failed:", e));
                }
              }
            }
          } catch (error) {
            console.error(`Failed to load ${type} stream:`, error);

            // Try to fallback to original video
            const video = container.querySelector(`#video-${postId}`);
            if (video) {
              console.log("Using fallback to original video");
              video.src = post.original_media_url;
              video.play().catch((e) => console.log("Play failed:", e));
            } else {
              alert(`Failed to load ${type} stream. Please try again.`);
            }
          }
        }

        toggleStreaming(postId, type) {
          // Legacy method for backward compatibility
          this.loadStreaming(postId, type);
        }

        async checkProcessingStatus(postId) {
          const checkStatus = async () => {
            try {
              const response = await fetch(`/api/posts/${postId}/status`);
              const result = await response.json();

              if (result.success) {
                if (result.status === "ready") {
                  this.loadPosts(); // Reload posts to show the processed video
                  return;
                } else if (result.status === "failed") {
                  this.loadPosts(); // Reload to show error
                  return;
                } else if (result.status === "processing") {
                  // Continue checking
                  setTimeout(checkStatus, 5000);
                }
              }
            } catch (error) {
              console.error("Error checking status:", error);
            }
          };

          setTimeout(checkStatus, 2000); // Start checking after 2 seconds
        }
      }

      // Initialize the app
      const ultraFastSocial = new UltraFastSocial();
    </script>
  </body>
</html>
